{"components/doogma-pack/doogma-pack-product/doogma-pdp-script":"<script\r\n  src=\"https://dynaviewcode.doogma.com/dist/dynaviewer1.2/dynaviewer.js\"\r\n  defer\r\n></script>\r\n<!--<script-->\r\n<!--  src=\"https://cdntestdynaviewcode.doogma.com/dist/dynaviewer1.2/dynaviewer.js\"-->\r\n<!--  defer-->\r\n<!--></script>-->\r\n<script>\r\n      window.currentDpParameters = {\r\n          original: {},\r\n          modified: {}\r\n      };\r\n\r\n\r\n      window.DynaViewerState = {}\r\n      window.DynaViewerData = {}\r\n\r\n      var uploaderField;\r\n\r\n      // dispatch changes for input that changed programmatically\r\n      const descriptor = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value');\r\n      const textInputElPropMod = (input) => {\r\n        // Check if the property is already modified or not configurable\r\n        const currentDescriptor = Object.getOwnPropertyDescriptor(input, 'value');\r\n        if (currentDescriptor && !currentDescriptor.configurable) {\r\n          return; // Skip if property is not configurable\r\n        }\r\n\r\n        // Check if we've already modified this element\r\n        if (input._doogmaModified) {\r\n          return;\r\n        }\r\n\r\n        Object.defineProperty(input, 'value', {\r\n          get: descriptor.get,\r\n          set: function(val) {\r\n            descriptor.set.call(this, val);\r\n            this.dispatchEvent(new Event('input', { bubbles: true }));\r\n          },\r\n          configurable: true\r\n        });\r\n\r\n        // Mark as modified to prevent duplicate modifications\r\n        input._doogmaModified = true;\r\n      }\r\n\r\n      const setInternalState = (canvasId, params) => {\r\n\r\n          Object.keys(params)\r\n          .forEach((key) => window.DynaViewerState[key] = params[key]);\r\n          if (canvasId) {\r\n              console.log('updating DynaViewerCanvas', params, window.DynaViewerState);\r\n              updateDynaviewerCanvas(canvasId, params);\r\n              storeModifiedParameters(Object.keys(params)[0], params[Object.keys(params)[0]] )\r\n\r\n              let storeModifiedParametersInSession = { [Object.keys(params)[0]]: params[Object.keys(params)[0]] };\r\n\r\n              console.log(\"session storage\");\r\n              console.log(storeModifiedParametersInSession);\r\n\r\n              const eventForSessionOnUpdate = new CustomEvent(\"eventForSessionManagement\", { detail: storeModifiedParametersInSession });\r\n              document.dispatchEvent(eventForSessionOnUpdate);\r\n          }\r\n      }\r\n\r\n      const storeModifiedParameters = ( modifiedParamKey, modifiedParamValue ) => {\r\n\r\n          // Ensure the modified object exists\r\n          if (!window.currentDpParameters.modified) {\r\n              window.currentDpParameters.modified = {};\r\n          }\r\n\r\n          // Update or add the key-value pair\r\n          window.currentDpParameters.modified[modifiedParamKey] = modifiedParamValue;\r\n\r\n          // Remove any keys that are named \"undefined\" or have undefined values\r\n          for (const key in window.currentDpParameters.modified) {\r\n              if (key === \"undefined\" || window.currentDpParameters.modified[key] === undefined) {\r\n                  delete window.currentDpParameters.modified[key];\r\n              }\r\n          }\r\n      }\r\n\r\n      const saveParam = (key, value) => {\r\n          if (key === 'dp_design') {\r\n            return\r\n          }\r\n\r\n          try {\r\n            const current = sessionStorage.getItem(window.DynaConfig.sessionKey)\r\n            let parsed = {}\r\n            if (current) {\r\n              parsed = JSON.parse(current)\r\n            }\r\n            parsed[key] = value\r\n            sessionStorage.setItem(window.DynaConfig.sessionKey, JSON.stringify(parsed))\r\n\r\n\r\n\r\n\r\n          } catch(error) {\r\n               console.error(\"An error occurred:\", error.message); // Logs only the error message\r\n              console.error(\"Stack trace:\", error.stack); // Logs the complete error stack\r\n            console.error('error saving DP params')\r\n\r\n          }\r\n       }\r\n\r\n      const saveParamFromDynaviewConfig = () => {\r\n\r\n          try {\r\n            const current = sessionStorage.getItem(window.DynaConfig.sessionKey)\r\n            let parsed = {}\r\n            if (current) {\r\n              parsed = JSON.parse(current)\r\n            }\r\n          //   parsed[key] = value\r\n\r\n            //storing in session from DynaConfig\r\n            const sessionStoreModifiers = window.DynaConfig.sessionStoreModifiers;\r\n            const sessionStoreModifiersArray = sessionStoreModifiers.split('|');\r\n            let {productOptions} = JSON.parse({{jsContext}});\r\n            sessionStoreModifiersArray.forEach((sessionStoreModifier) => {\r\n                const found = productOptions.find((i) => i.display_name.toLowerCase() === sessionStoreModifier.trim().toLowerCase());\r\n                if (found) {\r\n                    parsed[sessionStoreModifier] = found.prefill\r\n                }\r\n            })\r\n\r\n            console.log(\"saving session\");\r\n            console.log(parsed);\r\n\r\n            sessionStorage.setItem(window.DynaConfig.sessionKey, JSON.stringify(parsed))\r\n\r\n\r\n\r\n\r\n          } catch {\r\n            console.error('error saving DP params')\r\n          }\r\n\r\n      }\r\n\r\n      const getParams = () => {\r\n          const current = sessionStorage.getItem(window.DynaConfig.sessionKey)\r\n\r\n          if (!current) {\r\n            return {}\r\n          }\r\n\r\n          return JSON.parse(current)\r\n       }\r\n\r\n      const isHexColor = (str) => {\r\n        return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(str);\r\n      }\r\n\r\n      const removeHashFromHexColor = (str) => {\r\n        if (isHexColor(str)) {\r\n          const noHash = str.replaceAll('#', '')\r\n          return noHash\r\n        } else {\r\n          return str\r\n        }\r\n      }\r\n\r\n      const productDataProcessor = (data) => {\r\n\r\n          let dynaViewerId = null; // Stores the value of 'dynaviewerid' custom field if found\r\n          const { customFields, productOptions } = data;\r\n          const dynamicDpParamsMap = {}; // Stores dynamic product parameters mapped by their option ID, these are variants\r\n          const staticDpParamsMap = {}; // Stores static product parameters mapped by custom field name, these are modifiers\r\n          const skuPartMap = {}; // Stores SKU part mappings based on variant groups, these are variant Groups\r\n\r\n          // Check if required data exists, throw an error if missing\r\n          if (!customFields || !productOptions) {\r\n              throw new Error('handlePDPCustomField: missing customFields or productOptions');\r\n          }\r\n\r\n          if (window.DynaConfig && window.DynaConfig.globalFields) {\r\n              // Loop through the object's entries (key-value pairs)\r\n              Object.entries(window.DynaConfig.globalFields).forEach(([key, value]) => {\r\n                // Create a new object with 'name' and 'value' properties\r\n                const newObject = {\r\n                  name: key,\r\n                  value: value\r\n                };\r\n                // Push the new object into the array\r\n                customFields.push(newObject);\r\n              });\r\n          }\r\n\r\n        console.log('customFields', customFields)\r\n\r\n          // Loop through all custom fields\r\n          customFields.forEach((customField) => {\r\n\r\n              //special condition id the dynaviewerid custom field is not defined with dd_\r\n              if (customField.name == 'dynaviewerid' ) {\r\n                dynaViewerId = customField.value;\r\n              }\r\n\r\n              if (customField.name === 'doogmaprintparameters') {\r\n                window.DoogmaPrintParameters = customField.value\r\n              }\r\n\r\n              // Check if the custom field name starts with \"dd_\", which indicates special handling\r\n              if (customField.name.indexOf('dd_') !== -1) {\r\n                  const cfName = customField.name.split('_'); // Extract key part of the custom field name\r\n                  const type = customField.value.split('_'); // Extract key part of the custom field value\r\n                  let found;\r\n\r\n                  // 1. If the custom field name contains \"dynaviewerid\", store its value\r\n                  if (cfName[1].toLowerCase() === 'dynaviewerid') {\r\n                      dynaViewerId = customField.value;\r\n                  // 2. If the custom field name contains \"hidden\", hide the corresponding modifier fields\r\n                  } else if (cfName[1].toLowerCase() === 'doogmaprintparameters') {\r\n                    window.DoogmaPrintParameters = customField.value\r\n                  }else if (cfName[1].toLowerCase() === 'hidden') {\r\n                      const hiddenFields = customField.value.split('|'); // Extract hidden field names\r\n                      hiddenFields.forEach((hiddenField) => {\r\n                          // Find matching product option based on display name\r\n                          const found = productOptions.find((i) => i.display_name.toLowerCase() === hiddenField.trim().toLowerCase());\r\n                          if (found) {\r\n                              // Locate and hide the corresponding form field\r\n                              const el = document.querySelector('[name=\"attribute[' + found.id + ']\"]');\r\n                              const field = el ? el.closest('.form-field') : null;\r\n                              if (field) {\r\n                                  field.style.display = 'none';\r\n                              }\r\n                          }\r\n                      });\r\n                  // 3. If the custom field value contains \"modifier_\", add it to the staticDpParamsMap\r\n                  } else {\r\n                      if (type.length > 1 && type[0].includes('modifier')) {\r\n                          found = productOptions.find((i) => i.display_name.toLowerCase() === type[1].toLowerCase());\r\n                          if (found) {\r\n                              staticDpParamsMap[customField.name] = found;\r\n                          }\r\n                      }\r\n                  }\r\n              }\r\n\r\n              // Check if the custom field name starts with \"dp_\", which indicates a different type of handling\r\n              if (customField.name.indexOf('dp_') !== -1) {\r\n                  const type = customField.value.split('_');\r\n                  let found;\r\n\r\n                  // 4. Handle variant groups by mapping them to SKU part positions\r\n                  if (customField.value.indexOf('variantgroup_') > -1) {\r\n                      const position = type[1] ? parseInt(type[1]) : null;\r\n                      if (position !== null) {\r\n                          skuPartMap[position] = customField.name;\r\n                      }\r\n                      return;\r\n                  }\r\n\r\n                  // 5. Find matching product option based on display name\r\n                  if (type.length > 1 && customField.value.indexOf('|') === -1) {\r\n                      found = productOptions.find((i) => i.display_name.toLowerCase() === type[1].toLowerCase());\r\n                  } else if (type.length > 1 && customField.value.indexOf('|') !== -1) {\r\n              // check for prefix here\r\n                    const isSpecial = inspectCharacter(customField.value)\r\n                    const prefix = isSpecial !== null && isSpecial.result === true ? isSpecial.prefix : undefined\r\n                    const suffix = isSpecial !== null && isSpecial.isLastCharSpecial === true ? isSpecial.suffix : undefined\r\n                    let sanitizedValue = typeof prefix !== 'undefined' ? customField.value.slice(1) : customField.value\r\n\r\n                    if (suffix) {\r\n                      sanitizedValue = sanitizedValue.slice(0, -1)\r\n                    }\r\n\r\n                    // --- GROUP ALL PARTS UNDER dpName KEY ---\r\n                    let groupArr = [];\r\n                    sanitizedValue.split('|')\r\n                    .map((mod, index) => {\r\n                        const split = mod.split(\"_\")\r\n                        return {\r\n                          name: split[1],\r\n                          useHexValue: split[0].toLowerCase().indexOf('hexmodifier') >= 0 || split[0].toLowerCase().indexOf('hexvariant') >= 0,\r\n                          valIndex: index\r\n                        }\r\n                    })\r\n                    .forEach((mod) => {\r\n                        const f = productOptions.find((i) => i.display_name.toLowerCase() === mod.name.toLowerCase())\r\n                        if (f) {\r\n                          groupArr.push({\r\n                              data: f,\r\n                              dpName: customField.name,\r\n                              useHexValue: mod.useHexValue,\r\n                              valIndex: mod.valIndex,\r\n                              prefix: prefix,\r\n                              suffix: suffix\r\n                          });\r\n                        }\r\n                    });\r\n                    if (groupArr.length) {\r\n                      dynamicDpParamsMap[customField.name] = groupArr;\r\n                    }\r\n                  } else {\r\n                      staticDpParamsMap[customField.name] = customField.value;\r\n                  }\r\n              //variant_Product Size|modifier_Select Layout\r\n              // dp_sizelayout\r\n\r\n                  // 6. If a matching product option is found, store it in the dynamic parameters map\r\n                  if (found) {\r\n                      if (!dynamicDpParamsMap[found.id]) {\r\n                          dynamicDpParamsMap[found.id] = [];\r\n                      }\r\n                      const entry = {\r\n                          data: found,\r\n                          dpName: customField.name\r\n                      };\r\n                      if (customField.value.toLowerCase().indexOf('hexmodifier') >= 0 ||\r\n                          customField.value.toLowerCase().indexOf('hexvariant') >= 0) {\r\n                          entry.useHexValue = true;\r\n                      }\r\n                      dynamicDpParamsMap[found.id].push(entry);\r\n                  }\r\n              }\r\n          });\r\n\r\n          return {\r\n              dynaViewerId, // Stores the value of the \"dynaviewerid\" custom field\r\n              staticDpParamsMap, // these are just the custom fields not mapped to any modifier or variant\r\n              dynamicDpParamsMap, // these are variants and modifiers\r\n              skuPartMap // these are variantgroups\r\n          };\r\n    }\r\n\r\n      const autofillStaticDpParams = (params, designId) => {\r\n          Object.keys(params).forEach(key => {\r\n              if (key === 'dd_saveddesign') {\r\n                const el = document.querySelector('[name=\"attribute['+params.dd_saveddesign.id+']\"]')\r\n                const baseUrl = window.DynaConfig.renderUrl + '?design='+window.DynaConfig.clientId+'~'\r\n                if (el) {\r\n                  el.value = baseUrl + designId;\r\n                }\r\n              }\r\n\r\n              if (key === 'dd_saveddesignlink') {\r\n                const el = document.querySelector('[name=\"attribute['+params.dd_saveddesignlink.id+']\"]')\r\n                if (el) {\r\n                  el.value = window.location.origin + window.location.pathname + '?dd_json=' +designId;\r\n                }\r\n              }\r\n\r\n              if (window.DoogmaPrintParameters && key.includes('printoutput')) {\r\n                let printUrl = window.DynaConfig.renderUrl + '?design=' + window.DynaConfig.clientId + '~'+ designId;\r\n                printUrl += window.DoogmaPrintParameters\r\n\r\n               const current = params[key]\r\n                if (current.id) {\r\n                  const el = document.querySelector('[name=\"attribute['+current.id+']\"]')\r\n                      if (el) {\r\n                        el.value = printUrl\r\n                      }\r\n                }\r\n              }\r\n          });\r\n\r\n      }\r\n\r\n      const getInitialValueFromOptions = (data) => {\r\n          console.log(\"getInitialValueFromOptions\")\r\n          console.log(data)\r\n          if (Array.isArray(data.values) && data.values.length > 0) {\r\n            const found = data.values.find((v) => v.selected)\r\n            if (found) {\r\n              return {\r\n                id: found.id,\r\n                dataValue: found.data,\r\n                label: found.label\r\n              }\r\n            }\r\n          } else if (data.prefill && data.prefill.indexOf('{\"type\":') === -1) {\r\n\r\n              return data.prefill\r\n          } else if (data.prefill && data.prefill.indexOf('{\"type\":') > -1) {\r\n                try {\r\n                  const conf = JSON.parse(data.prefill);\r\n                  if (conf.default) {\r\n                    return conf.default\r\n                  }\r\n                } catch {\r\n                  return undefined\r\n                }\r\n          }\r\n      }\r\n\r\n      const skuParser = (sku, skuPartMap) => {\r\n          const parts = sku.split('-');\r\n          const result = {}\r\n\r\n          Object.keys(skuPartMap).forEach((key, idx) => {\r\n            if (parts[key] && parts[key].length >= 3) {\r\n              result[skuPartMap[key]] = parts[key] !== key + '00' ? parts[key] : 'none'\r\n            }\r\n          })\r\n\r\n          return result\r\n      }\r\n\r\n      const fillDynamicDpParamsMap = (args) => {\r\n    const { state, dynamicDpParamsMap } = args;\r\n\r\n    console.log(\"dynamic param function for testing console\");\r\n    console.log(args);\r\n\r\n    Object.keys(dynamicDpParamsMap)\r\n      .forEach((key) => {\r\n        dynamicDpParamsMap[key].forEach((current) => {\r\n          // console.log(current);\r\n          // get value from state\r\n          const val = state[current.dpName];\r\n          if (!val || !current.data) {\r\n            return;\r\n          }\r\n\r\n          // Handle grouped parameters with prefixes/suffixes\r\n          if (typeof current.valIndex !== 'undefined') {\r\n            let { customFields } = JSON.parse({{ jsContext }});\r\n            let connectedField = customFields.find(field => field.name === current.dpName);\r\n            let connectedFieldVal = connectedField.value;\r\n\r\n            //getting the modifier name\r\n            const parts = connectedFieldVal.split('|').filter(Boolean);\r\n            const first = parts[0].split('_')[1];     // \"Size|\"\r\n            let second = undefined\r\n            if (parts[1]) {\r\n              second = parts[1].split('_')[1];\r\n            }\r\n\r\n\r\n            // getting the modifiers value\r\n            // Step 1: Remove leading/trailing pipes and split by \"_\"\r\n            const cleaned = val.replaceAll('|', '').split('_');\r\n            // Step 2: Assign to variables\r\n            const firstValue = cleaned[0];  // \"size1\"\r\n            const secondValue = cleaned[1]; // \"layout9\"\r\n\r\n            // console.log(\"Hello********\");\r\n            // console.log(first+\":-\"+firstValue)\r\n            // console.log(second+\":-\"+secondValue)\r\n            let groupedCurrentData = current;\r\n            if(current.valIndex==0){\r\n              handelingOptions(groupedCurrentData,firstValue,true);\r\n            }else{\r\n              handelingOptions(groupedCurrentData,secondValue,true);\r\n            }\r\n\r\n\r\n          }else{\r\n            handelingOptions(current,val);\r\n          }\r\n\r\n\r\n          function handelingOptions(current,val,concatVal=false){\r\n            console.log(\"current********\");\r\n            console.log(current);\r\n            console.log(val);\r\n\r\n            let currentObject = current.data;\r\n\r\n\r\n\r\n            // text input or textarea\r\n            if (  currentObject.values.length === 0) {\r\n              const inpt = document.querySelector('[name=\"attribute[' + currentObject.id + ']\"]');\r\n              if (inpt) {\r\n                inpt.value = val;\r\n\r\n                // if the input is a doogma file field, dispatch an input event\r\n                if (inpt && inpt.classList.contains('doogma-file-field')) {\r\n                  inpt.dispatchEvent(new Event('input', { bubbles: true }));\r\n                }\r\n              }\r\n            } else if (currentObject.partial == \"set-select\") {\r\n\r\n              //finding the selected option in select\r\n              const selectSelectedItem = currentObject.values.find(item => item.selected === true);\r\n              console.log(selectSelectedItem);\r\n\r\n              if (selectSelectedItem) {\r\n                var selectEl = document.querySelector('[name=\"attribute[' + currentObject.id + ']\"]');\r\n                selectByText(selectEl, val); // This will select the option with text \"Center\"\r\n              }\r\n\r\n            } else {\r\n              const selectedVal = currentObject.values.find((v) => {\r\n                if (Array.isArray(v.data) && current.useHexValue) {\r\n                  const dataRes = v.data.some((vd) => vd.toLowerCase() === val.toLowerCase());\r\n                  return dataRes;\r\n                }\r\n\r\n                if (Array.isArray(v.data) && !current.useHexValue) {\r\n                  return v.label === val;\r\n                }\r\n\r\n                // Check if v.data has image key\r\n                if (typeof v === 'object' && v.image) {\r\n                  return v.label === val;\r\n                }\r\n\r\n\r\n\r\n                return v.data === val;\r\n              });\r\n\r\n              if (selectedVal) {\r\n                const inpt = document.querySelector('[name=\"attribute[' + currentObject.id + ']\"][value=\"' + selectedVal.id + '\"]');\r\n                if (inpt) {\r\n                  inpt.click();\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n        });\r\n      });\r\n\r\n\r\n    toggleDynaViewer(true);\r\n  }\r\n\r\n      // const fillDynamicDpParamsMap = (args) => {\r\n      //     const {state, dynamicDpParamsMap} = args\r\n\r\n      //     console.log(\"dynamic param fiunction for tesing console\");\r\n      //     console.log(args)\r\n\r\n      //     Object.keys(dynamicDpParamsMap)\r\n      //       .forEach((key) => {\r\n      //         const current = dynamicDpParamsMap[key]\r\n      //         console.log(current)\r\n      //         // get value from state\r\n      //         const val = state[current.dpName]\r\n      //         if (!val || !current.data) {\r\n      //           return\r\n      //         }\r\n\r\n      //         // text input or textarea\r\n      //         if (current.data.values.length === 0) {\r\n      //           const inpt = document.querySelector('[name=\"attribute['+current.data.id+']\"]')\r\n      //           if (inpt) {\r\n      //             inpt.value = val\r\n\r\n      //             // if the input is a doogma file field, dispatch an input event\r\n      //             if (inpt && inpt.classList.contains('doogma-file-field')) {\r\n      //               inpt.dispatchEvent(new Event('input', { bubbles: true }));\r\n      //             }\r\n      //           }\r\n      //         } else if(current.data.partial == \"set-select\"){\r\n\r\n      //             //finding the selected option in select\r\n      //             const selectSelectedItem = current.data.values.find(item => item.selected === true);\r\n      //             console.log(selectSelectedItem);\r\n\r\n      //             if( selectSelectedItem ){\r\n      //                 var selectEl = document.querySelector('[name=\"attribute['+current.data.id+']\"]')\r\n      //                 // const selectEl = document.getElementById('mySelect');\r\n      //                 selectByText(selectEl, val); // This will select the option with text \"Center\"\r\n      //             }\r\n\r\n\r\n      //         }else {\r\n      //           const selectedVal = current.data.values.find((v) => {\r\n      //             if (Array.isArray(v.data) && current.useHexValue) {\r\n      //               const dataRes = v.data.some((vd) => vd.toLowerCase() === val.toLowerCase())\r\n      //               return dataRes\r\n      //             }\r\n\r\n      //             if (Array.isArray(v.data) && !current.useHexValue) {\r\n      //               return v.label === val\r\n      //             }\r\n\r\n      //             return v.data === val\r\n      //           })\r\n\r\n      //           if (selectedVal) {\r\n      //             const inpt = document.querySelector('[name=\"attribute['+current.data.id+']\"][value=\"'+selectedVal.id+'\"]')\r\n      //             if (inpt) {\r\n      //               inpt.click();\r\n      //               // console.log(\"prefilled input\", inpt)\r\n      //             }\r\n      //           }\r\n      //         }\r\n      //     })\r\n\r\n\r\n      //     toggleDynaViewer(true)\r\n      // }\r\n\r\n\r\n\r\n      function selectByText(selectEl, text) {\r\n        for (let i = 0; i < selectEl.options.length; i++) {\r\n          if (selectEl.options[i].text.trim() === text.trim()) {\r\n            selectEl.selectedIndex = i;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      let isObservingPreviewCart = false\r\n      let renderLink = ''\r\n      const observer = new MutationObserver((mutationsList) => {\r\n          for (const mutation of mutationsList) {\r\n            if (\r\n              mutation.type === 'childList' ||\r\n              mutation.type === 'subtree'\r\n            ) {\r\n              const imgCont = mutation.target.querySelector('.productView-img-container')\r\n              if (imgCont) {\r\n                const img = document.createElement('img')\r\n                img.src = renderLink\r\n                img.classList.add('productView-image--cart')\r\n                imgCont.innerHTML = ''\r\n                imgCont.appendChild(img)\r\n              }\r\n            }\r\n          }\r\n        });\r\n      const observePreviewCart = (target) => {\r\n        if (!target) {\r\n          return\r\n        }\r\n        observer.observe(target, {\r\n                childList: true, // watches for addition/removal of child nodes\r\n                subtree: true,   // watches the whole descendant tree\r\n                attributes: true\r\n              });\r\n      }\r\n\r\n      const handleAddToCart = (originalSubmitBtn, staticParamsMap, dynaViewerCanvas) => {\r\n          console.log('saveDynaviewerDesign', dynaViewerCanvas)\r\n          saveDynaviewerDesign(dynaViewerCanvas, undefined, {\r\n            licenseKey: window.DynaConfig.licenseKey\r\n          })\r\n          .then((saveDesignResult) => {\r\n          console.log('saveDesignResult', saveDesignResult)\r\n          renderLink = window.DynaConfig.renderUrl+'?design='+window.DynaConfig.projectId+'~'+ saveDesignResult.designId;\r\n          autofillStaticDpParams(staticParamsMap, saveDesignResult.designId);\r\n          originalSubmitBtn.click();\r\n          const previewCart = document.querySelector('#previewModal');\r\n          if (!isObservingPreviewCart) {\r\n            isObservingPreviewCart = true;\r\n            observePreviewCart(previewCart)\r\n         } else {\r\n              waitForElement('.previewCart .productView-img-container img', () => {\r\n                const imgCont = document.querySelector('.previewCart .productView-img-container')\r\n                if (imgCont) {\r\n                  const img = document.createElement('img')\r\n                  img.src = renderLink\r\n                  img.classList.add('productView-image--cart')\r\n                  imgCont.innerHTML = ''\r\n                  imgCont.appendChild(img)\r\n                }\r\n              }, 25)\r\n\r\n          }\r\n                  // console.log('saveDesignResult', saveDesignResult)\r\n          // const renderLink = window.DynaConfig.renderUrl+'?design='+window.DynaConfig.projectId+'~'+ saveDesignResult.designId;\r\n          // fetch(window.DynaConfig.jsonAPIUrl+'/jsonprojects/'+ window.DynaConfig.projectId +'/jsons/' + saveDesignResult.designId, {\r\n          //     method: 'PUT',\r\n          //     headers: {\r\n          //       'Content-Type': 'application/json'\r\n          //     },\r\n          //     body: JSON.stringify({\r\n          //       json: {\r\n          //         state: window.DynaViewerState\r\n          //       }\r\n          //     })\r\n          // })\r\n          //   .then(() => {\r\n          //     autofillStaticDpParams(staticDpParamsMap, saveDesignResult.designId);\r\n          //     originalSubmitBtn.click();\r\n          //     waitForElement('.previewCart .productView-img-container', () => {\r\n          //       const imgCont = document.querySelector('.previewCart .productView-img-container')\r\n          //       if (imgCont) {\r\n          //         const img = document.createElement('img')\r\n          //         img.src = renderLink\r\n          //         img.classList.add('productView-image--cart')\r\n          //         imgCont.innerHTML = ''\r\n          //         imgCont.appendChild(img)\r\n          //       }\r\n          //     }, 25)\r\n          //   })\r\n\r\n          })\r\n         .catch((err) => {\r\n            console.error(err)\r\n          })\r\n      }\r\n\r\n      const waitForElement = (selector, callback, time, elapsedTime) => {\r\n          let newElapsedTime = time;\r\n          if (elapsedTime) {\r\n              newElapsedTime = elapsedTime + time;\r\n          }\r\n\r\n          if (newElapsedTime > 50000) {\r\n              console.log('failed to find:', selector);\r\n              return;\r\n          }\r\n\r\n          if (typeof selector !== 'string') {\r\n              const found = [];\r\n              selector.forEach((s) => {\r\n                  const className = s.replace(/\\s/g,'');\r\n                  if (document.querySelector(className) !== null) {\r\n                      found.push(s);\r\n                  }\r\n              });\r\n\r\n              if (found.length === selector.length) {\r\n                  callback();\r\n                  return;\r\n              }\r\n          }\r\n\r\n          if (typeof selector === 'string' && document.querySelector(selector) !== null) {\r\n              callback();\r\n              return;\r\n          }\r\n          setTimeout(() => {\r\n              waitForElement(selector, callback, time, newElapsedTime);\r\n          }, time);\r\n      }\r\n      // thumb injectors\r\n      const injectDoogmaThumb = (val, el) => {\r\n          console.log('injecting doogma thumb', val, el)\r\n          if (el !== null) {\r\n              el.innerHTML = \"\";\r\n              const img = document.createElement(\"img\");\r\n              img.src = val.trim();\r\n              img.classList.add(\"productView-image--cart\");\r\n              el.appendChild(img);\r\n          }\r\n      }\r\n\r\n      const cartPreviewThumbInjector = (response) => {\r\n          let cartConfig = null;\r\n          if (!!window.doogmaStorefront.data.store.cart_config) {\r\n              cartConfig = JSON.parse(window.doogmaStorefront.data.store.cart_config);\r\n          }\r\n          const   quickViewVis = cartConfig !== null &&typeof cartConfig.quick_view_vis !== 'undefined' ? cartConfig.quick_view_vis : \".previewCart .productView-img-container\",\r\n                  quickViewItem = cartConfig !== null && typeof cartConfig.quick_view_item !== 'undefined' ? cartConfig.quick_view_item : \"dt.productView-info-name\",\r\n                  quickViewItemContainer = cartConfig !== null && typeof cartConfig.quick_view_item_container !== 'undefined' ? cartConfig.quick_view_item_container : \"dd\",\r\n                  quickViewOptName = cartConfig !== null && typeof cartConfig.quick_view_opt_name !== 'undefined' ? cartConfig.quick_view_opt_name : '.previewCart .productView-info-name',\r\n                  cartItemThumbLabel = cartConfig !==  null && typeof cartConfig.cart_item_thumb_label !== 'undefined' ? cartConfig.cart_item_thumb_label : ['View Your Proof'];\r\n\r\n          waitForElement(quickViewVis, () => {\r\n\r\n              if (window.DynaGeneratedValues.savedDesign) {\r\n                  injectDoogmaThumb(window.DynaGeneratedValues.savedDesign, quickViewVisEl);\r\n              }\r\n          }, 25);\r\n      }\r\n      // end of thumb injectors\r\n\r\n\r\n\r\n\r\n      //will be neede if need to change the uploader div modifications\r\n      const uploaderDivModifications = (uploaderField) => {\r\n          if(!uploaderField){\r\n\r\n              document.querySelectorAll('.productView-options input.doogma-file-field').forEach(function(input) {\r\n                  let parentDiv = input.closest('div');\r\n                  let uploaderFieldValue = input.value;\r\n                  let uploaderFieldParentElm = uploaderField.parentElement;\r\n                  uploaderDivModificationsInnerFunction( uploaderFieldValue,parentDiv )\r\n              });\r\n\r\n          }else{\r\n              let uploaderFieldValue = uploaderField.value;\r\n              let uploaderFieldParentElm = uploaderField.parentElement;\r\n              uploaderDivModificationsInnerFunction( uploaderFieldValue,uploaderFieldParentElm )\r\n\r\n\r\n          }\r\n\r\n          function uploaderDivModificationsInnerFunction( uploaderFieldValue,uploaderFieldParentElm ){\r\n              const labelText = uploaderFieldParentElm.querySelector( \".dyna-uploader-fname\" ).dataset.label;\r\n              if( uploaderFieldValue ){\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-label\" ).classList.add( 'hasFile' );\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-label\" ).classList.remove( 'noFile' );\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-fname\" ).textContent = 'Replace ' + labelText;\r\n              }else{\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-label\" ).classList.add( 'noFile' );\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-label\" ).classList.remove( 'hasFile' );\r\n                  uploaderFieldParentElm.querySelector( \".dyna-uploader-fname\" ).textContent = 'Upload ' + labelText;\r\n              }\r\n          }\r\n      }\r\n\r\n\r\n      const toggleDynaViewer = (active) => {\r\n          let trigger = document.querySelector('a.dynaViewer-trigger');\r\n\r\n          let productViewFig = document.querySelector('.productView-image')\r\n          let productViewImg = document.querySelector('.productView-img-container')\r\n          let dynaViewerWrapper = document.querySelector('#dynaviewer-wrapper')\r\n          const thumb = document.querySelector(window.DynaConfig.productViewThumbSelector ? window.DynaConfig.productViewThumbSelector : '.productView-thumbnail')\r\n          const thumbLinks = Array.from(document.querySelectorAll((window.DynaConfig.productThumbSelector? window.DynaConfig.productThumbSelector : '.productView-thumbnail') + ' a'))\r\n\r\n        if (active) {\r\n          productViewFig?.classList.add('disable-zoom')\r\n          thumbLinks.forEach((t) => t.classList.remove('is-active'))\r\n          trigger?.classList.add('is-active')\r\n          productViewImg?.classList.remove('active')\r\n          productViewImg?.classList.add('inactive')\r\n          dynaViewerWrapper?.classList.add('active')\r\n          dynaViewerWrapper?.classList.remove('inactive')\r\n          if (window.DynaViewerMiddleware && window.DynaViewerMiddleware.onShow) {\r\n            window.DynaViewerMiddleware.onShow()\r\n          }\r\n        } else {\r\n          productViewFig?.classList.remove('disable-zoom')\r\n          trigger?.classList.remove('is-active')\r\n          productViewImg?.classList.add('active')\r\n          productViewImg?.classList.remove('inactive')\r\n          dynaViewerWrapper?.classList.add('inactive')\r\n          dynaViewerWrapper?.classList.remove('active')\r\n\r\n          if (window.DynaViewerMiddleware && window.DynaViewerMiddleware.onHide) {\r\n            window.DynaViewerMiddleware.onHide()\r\n          }\r\n        }\r\n      }\r\n\r\n      const inspectCharacter = (text) => {\r\n          // Check if the input text is valid and not empty\r\n          if (!text || text.length === 0) {\r\n              console.warn(\"Input string is empty or null.\");\r\n              // Return null if the input is invalid\r\n              return null;\r\n          }\r\n\r\n          // Get the first character\r\n          const firstChar = text.charAt(0);\r\n\r\n          // Get the last character\r\n          // For a single character string, lastChar will be the same as firstChar\r\n          const lastChar = text.charAt(text.length - 1);\r\n\r\n          // Regular expression to match a single alphanumeric character\r\n          // ^ asserts position at start of the string\r\n          // [a-zA-Z0-9] matches any letter (uppercase or lowercase) or any digit\r\n          // $ asserts position at the end of the string\r\n          // So, /^[a-zA-Z0-9]$/ matches a string that consists of exactly one alphanumeric character.\r\n          const alphanumericRegex = /^[a-zA-Z0-9]$/;\r\n\r\n          // Test if the first character is NOT alphanumeric\r\n          const isFirstCharSpecial = !alphanumericRegex.test(firstChar);\r\n\r\n          // Test if the last character is NOT alphanumeric\r\n          const isLastCharSpecial = !alphanumericRegex.test(lastChar);\r\n\r\n          // Determine the suffix: the last character if it's special, otherwise null\r\n          const suffixValue = isLastCharSpecial ? lastChar : undefined;\r\n\r\n          // Return an object with the analysis\r\n          return {\r\n              result: isFirstCharSpecial,        // Boolean: true if the first character is special\r\n              prefix: firstChar,                 // String: the first character of the input string\r\n              isLastCharSpecial: isLastCharSpecial, // Boolean: true if the last character is special\r\n              suffix: suffixValue,               // String/null: the last character if it is special, otherwise null\r\n          };\r\n      };\r\n\r\n      const getDefaultGroupValue = (dpName, dynamicDpParamsMap) => {\r\n          let filtered = [];\r\n          let prefix = undefined;\r\n          let suffix = undefined;\r\n          for (const [key, arr] of Object.entries(dynamicDpParamsMap)) {\r\n            arr.forEach((value) => {\r\n              if (value.dpName === dpName) {\r\n                filtered.push({\r\n                  key: key,\r\n                  ...value\r\n                });\r\n                if (value.prefix) {\r\n                  prefix = value.prefix;\r\n                }\r\n                if (value.suffix) {\r\n                  suffix = value.suffix;\r\n                }\r\n              }\r\n              if (value.rel && value.rel.dpName == dpName) {\r\n                filtered.push({\r\n                  key: key,\r\n                  ...value\r\n                });\r\n              }\r\n            });\r\n          }\r\n\r\n          const result = filtered.toSorted((a, b) => {\r\n            const aIdx = a.rel ? a.rel.valIndex : a.valIndex\r\n            const bIdx = b.rel ? b.rel.valIndex : b.valIndex\r\n            return aIdx - bIdx\r\n          }).map((i) => {\r\n            let value = ''\r\n            if (Array.isArray(i.data.values) && i.data.values.length > 0) {\r\n              const selected = i.data.values.find((v) => v.selected)\r\n              if (selected) {\r\n                value = i.useHexValue ? selected.value : selected.label\r\n              }\r\n            }\r\n            if (i.data.prefill) {\r\n              value = i.data.prefill\r\n            }\r\n            return value\r\n          })\r\n          .join('_');\r\n\r\n          if (prefix) {\r\n            let resultProcessed = result.replaceAll(prefix, '')\r\n            if (suffix) {\r\n              resultProcessed = resultProcessed.replaceAll(suffix, '')\r\n            }\r\n            return prefix + resultProcessed + (suffix ? suffix : prefix)\r\n          }\r\n\r\n          return result;\r\n      }\r\n\r\n      const updateGroupValue = (newValue, oldValue, index, prefix, suffix) => {\r\n        let oldValueProcessed = prefix ? oldValue.replaceAll(prefix, '') : oldValueProcessed\r\n        if (suffix) {\r\n          oldValueProcessed = oldValueProcessed.replaceAll(suffix, '')\r\n        }\r\n\r\n        const split = oldValueProcessed.split('_')\r\n        split[index] = newValue.toLowerCase();\r\n        const result = split.join('_')\r\n        console.log('result', result, split, index, oldValueProcessed)\r\n\r\n        if (prefix) {\r\n          return prefix + result + (suffix ? suffix : prefix)\r\n        }\r\n\r\n        return result\r\n      }\r\n\r\n      const updateRelValue = (viewerCanvas, value, rel, dynamicDpParamsMap) => {\r\n          const currentValue = typeof window.DynaViewerState[rel.dpName] === 'undefined'\r\n              ? getDefaultGroupValue(rel.dpName, dynamicDpParamsMap)\r\n              : window.DynaViewerState[rel.dpName]\r\n\r\n          const newVal = updateGroupValue(value, currentValue, rel.valIndex, rel.prefix, rel.suffix)\r\n        console.log('newVal', newVal)\r\n\r\n          setInternalState(viewerCanvas, {\r\n            [rel.dpName]: removeHashFromHexColor(newVal)\r\n          })\r\n\r\n      }\r\n\r\n\r\n      window.addEventListener('DOMContentLoaded',function () {\r\n\r\n          //saveParamFromDynaviewConfig();\r\n\r\n          const urlParams = new URLSearchParams(window.location.search)\r\n          const jsonLink = urlParams.get('dd_json')\r\n          const dynaViewerCanvas = 'dynaviewer-canvas'\r\n          const {dynaViewerId, staticDpParamsMap, dynamicDpParamsMap, skuPartMap} = productDataProcessor(JSON.parse({{jsContext}}))\r\n\r\n          console.log('consolong on page load, the jsontext and then variables from productDataProcessor function')\r\n          console.log(JSON.parse({{jsContext}}))\r\n          console.log(dynaViewerId, staticDpParamsMap, dynamicDpParamsMap)\r\n\r\n          const sku = document.querySelector('.productView-info-value[data-product-sku]')\r\n          let initialDPViewerParams = {}\r\n\r\n\r\n          const observer = new MutationObserver((mutations) => {\r\n            const latestMutation = mutations[mutations.length - 1];\r\n            if (latestMutation) {\r\n              const parsed = skuParser(latestMutation.target.innerText, skuPartMap)\r\n              console.log('updateDynaviewerCanvas', parsed)\r\n              setInternalState(dynaViewerCanvas, removeHashFromHexColor(parsed))\r\n            }\r\n          })\r\n\r\n          // if (sku) {\r\n          //   const initialParsedValue = skuParser(sku.innerText, skuPartMap);\r\n          //   Object.entries(initialParsedValue)\r\n          //     .forEach(([key, value]) => {\r\n          //       saveParam(key, value);\r\n          //       initialDPViewerParams[key] = value\r\n          //     })\r\n          //   observer.observe(sku, {\r\n          //     subtree: true,\r\n          //     characterData: true,\r\n          //     childList: true\r\n          //   })\r\n          // }\r\n\r\n\r\n          //adding the modifiers and their values in initialDPViewerParams for first rendering of visualization\r\n          Object.keys(staticDpParamsMap).forEach((key) => {\r\n            if (typeof staticDpParamsMap[key] === 'string') {\r\n              initialDPViewerParams[key] = staticDpParamsMap[key]\r\n            }\r\n\r\n            if (typeof staticDpParamsMap[key].prefill === 'string' && staticDpParamsMap[key].prefill !== '') {\r\n              initialDPViewerParams[key] = staticDpParamsMap[key].prefill\r\n            }\r\n          })\r\n\r\n          //current not getting used, keep it here as it was here\r\n          const debounce = (callback, waitTime) => {\r\n              let timer;\r\n              return (...args) => {\r\n                  clearTimeout(timer);\r\n                  timer = setTimeout(() => {\r\n                      callback(...args);\r\n                  }, waitTime);\r\n              };\r\n          }\r\n\r\n          // from options\r\n          Object.keys(dynamicDpParamsMap).forEach((key) => {\r\n            dynamicDpParamsMap[key].forEach((conf) => {\r\n\r\n              // inital dp params from options default value\r\n              const initialValue = getInitialValueFromOptions(conf.data)\r\n            //   console.log(\"initial values\");\r\n            //   console.log(initialValue)\r\n              if (typeof initialValue === 'string' && typeof conf.prefix === 'undefined') {\r\n                  initialDPViewerParams[conf.dpName] = initialValue\r\n              }\r\n\r\n              if (typeof initialValue !== 'undefined' && typeof initialValue !== 'string' && typeof initialValue.id !== 'undefined' && typeof conf.prefix === 'undefined') {\r\n                  initialDPViewerParams[conf.dpName] = conf.useHexValue ? initialValue.dataValue : initialValue.label\r\n              }\r\n\r\n              // initial value for concated fields\r\n              if (typeof conf.prefix !== 'undefined') {\r\n                initialDPViewerParams[conf.dpName] = getDefaultGroupValue(conf.dpName, dynamicDpParamsMap)\r\n              }\r\n\r\n              // addEventListener\r\n              if ((conf.data.partial === 'input-file' || conf.data.partial === 'textarea' || conf.data.partial === 'input-text' || conf.data.partial === 'input-numbers') && conf.data.values.length === 0) {\r\n\r\n                const el = document.querySelector('[name=\"attribute['+conf.data.id+']\"]')\r\n\r\n                if (conf.data.prefill.indexOf('{\"type\":\"file') !== -1) {\r\n                  const uploader = document.getElementById('dyna_uploader_' + conf.data.id)\r\n                  const parsedConf = JSON.parse(conf.data.prefill)\r\n\r\n                  if (uploader) {\r\n                    let resultFieldSelector = 'attribute_text_' + conf.data.id;\r\n                    const resultField =  document.getElementById(resultFieldSelector);\r\n                    uploaderField = resultField;\r\n\r\n                    let dpName = conf.dpName;\r\n                    const parentDiv = resultField.closest('.form-field')\r\n                    const doogmaField = parentDiv.querySelector('.doogma-file-field')\r\n                    const deleteButton = parentDiv.querySelector('.dyna-uploader-delete')\r\n\r\n                    deleteButton.addEventListener('click', function() {\r\n                      uploader.value = '';\r\n                      doogmaField.value = '';\r\n                      setInternalState(dynaViewerCanvas, {\r\n                        [dpName]: ''\r\n                      })\r\n                      const labelText = parentDiv.querySelector( \".dyna-uploader-fname\" ).dataset.label;\r\n                      parentDiv.querySelector( \".dyna-uploader-label\" ).classList.add( 'noFile' );\r\n                      parentDiv.querySelector( \".dyna-uploader-label\" ).classList.remove( 'hasFile' );\r\n                      parentDiv.querySelector( \".dyna-uploader-fname\" ).textContent = 'Upload ' + labelText;\r\n                    })\r\n\r\n                    uploader.addEventListener('change', (e) => {\r\n                      console.log('uploaderChange', e.target.files)\r\n                        const file = e.target.files[0];\r\n                        if (!file) {\r\n                          return\r\n                        }\r\n                        const formData = new FormData();\r\n                        // clear warning\r\n                        let warningEl = parentDiv.querySelector('.dyna-uploader-warning');\r\n                        if (warningEl) {\r\n                          warningEl.remove()\r\n                        }\r\n\r\n                        // filenameSpan.innerText = file.name\r\n                        formData.append('file', file)\r\n\r\n                        fetch(`https://imageloader.doogma.com/image/upload?clientId=${window.DynaConfig.clientId}&randomize`, {\r\n                          method: 'POST',\r\n                          body: formData\r\n                        })\r\n                          .then((res) => res.json())\r\n                          .then((res) => {\r\n\r\n                              // resultField.value = res.origImageUrl\r\n\r\n                              // el.dispatchEvent(new Event('input', { bubbles: true }));\r\n\r\n                              // if (res.origImageMetadata) {\r\n                              //     const resolutionThreshold = window.DynaConfig.resolutionThreshold ? window.DynaConfig.resolutionThreshold : 500;\r\n                              //     if (res.origImageMetadata.widthPx < resolutionThreshold || res.origImageMetadata.heightPx < resolutionThreshold) {\r\n                              //       warning = document.createElement('div')\r\n                              //       warning.classList.add('dyna-uploader-warning')\r\n                              //       warning.style = 'color: red; display: block; font-size: 12px'\r\n\r\n                              //       if (typeof window.DynaConfig.uploadWarning !== 'undefined') {\r\n                              //         warning.innerText = window.DynaConfig.uploadWarning(res.origImageMetadata, resolutionThreshold)\r\n                              //       } else {\r\n                              //         warning.innerText = ' Your image is ' + res.origImageMetadata.widthPx + '' + res.origImageMetadata.heightPx + ' pixels. To ensure print quality, upload an SVG or a PNG thats at least ' + resolutionThreshold + ' pixels in both width and height.'\r\n                              //       }\r\n\r\n                              //       parentDiv.appendChild(warning)\r\n                              //     }\r\n                              // }\r\n\r\n                              if (res.origImageMetadata && !res.processedImages) {\r\n\r\n                                  resultField.value = res.origImageUrl;\r\n\r\n\r\n                              }else if(res.origImageMetadata && res.processedImages){\r\n                                  // const resolutionThreshold = window.DynaConfig.resolutionThreshold ? window.DynaConfig.resolutionThreshold : 500;\r\n                                  resultField.value = res.processedImages[0].rasterImageUrl;\r\n                                  console.log(\"pdp uploaded\")\r\n                                  console.log(res.processedImages[0].rasterImageUrl)\r\n                              }else if( res.origImageUrl && res.rasterImageUrl){\r\n                                  resultField.value = res.rasterImageUrl;\r\n                              }\r\n\r\n                              const resolutionThreshold = window.DynaConfig.resolutionThreshold ? window.DynaConfig.resolutionThreshold : 500;\r\n                              if (\r\n                                ( res.origImageMetadata ) &&\r\n                                ( res.origImageMetadata.widthPx < resolutionThreshold || res.origImageMetadata.heightPx < resolutionThreshold )\r\n                              ) {\r\n                                warning = document.createElement('div')\r\n                                warning.classList.add('dyna-uploader-warning')\r\n                                warning.style = 'color: red; display: block; font-size: 12px'\r\n\r\n                                if (typeof window.DynaConfig.uploadWarning !== 'undefined') {\r\n                                  warning.innerText = window.DynaConfig.uploadWarning(res.origImageMetadata, resolutionThreshold)\r\n                                } else {\r\n                                  warning.innerText = ' Your image is ' + res.origImageMetadata.widthPx + '' + res.origImageMetadata.heightPx + ' pixels. To ensure print quality, upload an SVG or a PNG thats at least ' + resolutionThreshold + ' pixels in both width and height.'\r\n                                }\r\n\r\n                                parentDiv.appendChild(warning)\r\n                              }\r\n\r\n                              el.dispatchEvent(new Event('input', { bubbles: true }));\r\n\r\n\r\n\r\n                              toggleDynaViewer(true)\r\n                              console.log('updateDynaviewerCanvas', dynaViewerCanvas, dpName,res)\r\n                              console.log('res', res)\r\n                              uploaderDivModifications( resultField );\r\n                          })\r\n                          .catch((err) => {\r\n                            console.error(err)\r\n                          })\r\n                    })\r\n                  }\r\n                }\r\n\r\n                if (el && (!conf.data.prefill || conf.data.prefill.indexOf('{\"type\":\"file') === -1)) {\r\n                  textInputElPropMod(el)\r\n                  el.addEventListener('input', (e) => {\r\n                      let value = e.target.value\r\n                      if (typeof conf.valIndex !== 'undefined') {\r\n                          const currentValue = typeof window.DynaViewerState[conf.dpName] === 'undefined'\r\n                              ? getDefaultGroupValue(conf.dpName, dynamicDpParamsMap)\r\n                              : window.DynaViewerState[conf.dpName]\r\n                          value = updateGroupValue(e.target.value, currentValue, conf.valIndex, conf.prefix, conf.suffix)\r\n                      }\r\n                      console.log('listener1', value, el)\r\n                      setInternalState(dynaViewerCanvas, {\r\n                        [conf.dpName]: removeHashFromHexColor(value)\r\n                      })\r\n\r\n                      if (typeof conf.rel !== 'undefined') {\r\n                        updateRelValue(dynaViewerCanvas,value, conf.rel, dynamicDpParamsMap)\r\n                      }\r\n                  })\r\n                }\r\n\r\n                if (el && (conf.data.prefill || conf.data.prefill.indexOf('{\"type\":\"file') !== -1)) {\r\n                  el.addEventListener('input', (e) => {\r\n                      let value = e.target.value\r\n                      if (typeof conf.valIndex !== 'undefined') {\r\n                          const currentValue = typeof window.DynaViewerState[conf.dpName] === 'undefined'\r\n                              ? getDefaultGroupValue(conf.dpName, dynamicDpParamsMap)\r\n                              : window.DynaViewerState[conf.dpName]\r\n                          value = updateGroupValue(e.target.value, currentValue, conf.valIndex, conf.prefix, conf.suffix)\r\n                      }\r\n\r\n                      setInternalState(dynaViewerCanvas, {\r\n                        [conf.dpName]: removeHashFromHexColor(value)\r\n                      })\r\n\r\n                      if (typeof conf.rel !== 'undefined') {\r\n                        updateRelValue(dynaViewerCanvas, value, conf.rel, dynamicDpParamsMap)\r\n                      }\r\n                    //uploaderDivModifications( uploaderField );\r\n                  })\r\n                }\r\n\r\n              }else if( conf.data.partial === 'set-select' ){\r\n\r\n                 const selectEl = document.querySelector('[name=\"attribute['+conf.data.id+']\"]')\r\n\r\n                 selectEl.addEventListener('change', (e) => {\r\n\r\n                     var selectedText = selectEl.options[selectEl.selectedIndex].text.trim();\r\n\r\n                      if (typeof conf.valIndex !== 'undefined') {\r\n                          const currentValue = typeof window.DynaViewerState[conf.dpName] === 'undefined'\r\n                              ? getDefaultGroupValue(conf.dpName, dynamicDpParamsMap)\r\n                              : window.DynaViewerState[conf.dpName]\r\n                          selectedText = updateGroupValue(selectedText, currentValue, conf.valIndex, conf.prefix, conf.suffix)\r\n                      }\r\n                      setInternalState(dynaViewerCanvas, {\r\n                        [conf.dpName]: removeHashFromHexColor(selectedText)\r\n                      })\r\n\r\n                      if (typeof conf.rel !== 'undefined') {\r\n                        updateRelValue(dynaViewerCanvas, selectedText, conf.rel, dynamicDpParamsMap)\r\n                      }\r\n\r\n                  })\r\n\r\n              } else {\r\n                conf.data.values.forEach((val) => {\r\n                  const el = document.querySelector('[name=\"attribute['+conf.data.id+']\"][value=\"'+val.id+'\"]')\r\n                  if (el) {\r\n                    el.addEventListener('change', (e) => {\r\n                      if (e.target.checked) {\r\n                        console.log('updateDynaviewerCanvas',conf.dpName, conf.useHexValue ? val.data[0] : val.label)\r\n                        let value = conf.useHexValue ? val.data[0] : val.label\r\n                        if (typeof conf.valIndex !== 'undefined') {\r\n                            const currentValue = typeof window.DynaViewerState[conf.dpName] === 'undefined'\r\n                                ? getDefaultGroupValue(conf.dpName, dynamicDpParamsMap)\r\n                                : window.DynaViewerState[conf.dpName]\r\n                            value = updateGroupValue(value, currentValue, conf.valIndex, conf.prefix, conf.suffix)\r\n                        }\r\n\r\n                        setInternalState(dynaViewerCanvas, {\r\n                          [conf.dpName]: removeHashFromHexColor(value)\r\n                        })\r\n\r\n                        if (typeof conf.rel !== 'undefined') {\r\n                          updateRelValue(dynaViewerCanvas, value, conf.rel, dynamicDpParamsMap)\r\n                        }\r\n                      }\r\n                    })\r\n                  }\r\n                })\r\n              }\r\n            })\r\n          })\r\n\r\n          // // from storage\r\n          // const paramsFromStorage = getParams()\r\n          // Object.keys(paramsFromStorage).forEach((key) => {\r\n          //   initialDPViewerParams[key] = paramsFromStorage[key]\r\n          // })\r\n          // console.log(initialDPViewerParams, 'initialDPViewerParams')\r\n          // setInternalState(null, initialDPViewerParams)\r\n\r\n          // renderDynaviewerDesign(dynaViewerCanvas, dynaViewerId, initialDPViewerParams, {\r\n          //   licenseKey: window.DynaConfig.licenseKey\r\n          // })\r\n\r\n      const originalSubmitBtn = document.getElementById('form-action-addToCart');\r\n      let submitBtn = null\r\n\r\n      if (originalSubmitBtn) {\r\n        submitBtn = originalSubmitBtn.cloneNode();\r\n        submitBtn.setAttribute('id', 'doogma-submit-btn')\r\n        submitBtn.setAttribute('type', 'button')\r\n        originalSubmitBtn.style.display = 'none';\r\n        originalSubmitBtn.closest('.form-action').appendChild(submitBtn)\r\n        submitBtn.addEventListener('click', function(event) {\r\n          handleAddToCart(originalSubmitBtn, staticDpParamsMap, dynaViewerCanvas)\r\n        })\r\n      }\r\n\r\n      const form = document.querySelector('form[data-cart-item-add]')\r\n      const productViewFig = document.querySelector('.productView-image')\r\n      const fields = form ? Array.from(form.querySelectorAll('input,select')) : []\r\n      const productViewImg = document.querySelector('.productView-img-container')\r\n      const dynaViewerWrapper = document.querySelector('#dynaviewer-wrapper')\r\n      const thumb = document.querySelector(window.DynaConfig.productViewThumbSelector ? window.DynaConfig.productViewThumbSelector : '.productView-thumbnail')\r\n      const thumbLinks = Array.from(document.querySelectorAll((window.DynaConfig.productThumbSelector ? window.DynaConfig.productThumbSelector : '.productView-thumbnail') + ' a'))\r\n\r\n      // const toggleDynaViewer = (active) => {\r\n      //   const trigger = document.querySelector('a.dynaViewer-trigger');\r\n\r\n      //   if (active) {\r\n      //     productViewFig?.classList.add('disable-zoom')\r\n      //     trigger?.classList.add('is-active')\r\n      //     thumbLinks.forEach((t) => t.classList.remove('is-active'))\r\n      //     productViewImg?.classList.remove('active')\r\n      //     productViewImg?.classList.add('inactive')\r\n      //     dynaViewerWrapper?.classList.add('active')\r\n      //     dynaViewerWrapper?.classList.remove('inactive')\r\n      //   } else {\r\n      //     productViewFig?.classList.remove('disable-zoom')\r\n      //     trigger?.classList.remove('is-active')\r\n      //     productViewImg?.classList.add('active')\r\n      //     productViewImg?.classList.remove('inactive')\r\n      //     dynaViewerWrapper?.classList.add('inactive')\r\n      //     dynaViewerWrapper?.classList.remove('active')\r\n      //   }\r\n      // }\r\n\r\n      fields.forEach((f) => {\r\n\r\n          if (f.tagName === 'SELECT') {\r\n\r\n              f.addEventListener('change', () => {\r\n                  if (productViewImg && dynaViewerWrapper) {\r\n                      // window.dispatchEvent(new Event('resize'));\r\n                      toggleDynaViewer(true)\r\n                  }\r\n              })\r\n\r\n          }else{\r\n              //this is for all input type element\r\n              f.addEventListener('focus', () => {\r\n                  if (productViewImg && dynaViewerWrapper) {\r\n                  // window.dispatchEvent(new Event('resize'));\r\n                  toggleDynaViewer(true)\r\n                  }\r\n              })\r\n\r\n          }\r\n\r\n      })\r\n\r\n      // create thumbnail\r\n      if (thumb && window.DynaConfig.customThumb) {\r\n          console.log('thumblinks createlistener', thumbLinks)\r\n        thumbLinks.forEach((i) => {\r\n          i.addEventListener('click', () => {\r\n            console.log('thumblink clicked', i)\r\n            toggleDynaViewer(false)\r\n          })\r\n        })\r\n\r\n        const clone = thumb.cloneNode(true)\r\n        const link = clone.querySelector('a')\r\n        const clonedLink = link.cloneNode(true)\r\n        const img = clonedLink.querySelector('img')\r\n        clone.replaceChild(clonedLink, link)\r\n\r\n        clonedLink.addEventListener('click', () => {\r\n          toggleDynaViewer(true)\r\n        })\r\n\r\n        clonedLink.href = '#'\r\n        clonedLink?.classList.add('dynaViewer-trigger')\r\n        img.src = window.DynaConfig.customThumb\r\n        img.removeAttribute('data-srcset')\r\n        img.removeAttribute('srcset')\r\n        thumb.parentNode?.insertBefore(clone, thumb.nextSibling)\r\n      }\r\n\r\n\r\n\r\n      if (jsonLink) {\r\n        console.log('jsonLink')\r\n        renderDynaviewerDesign(dynaViewerCanvas, window.DynaConfig.projectId + '~' + jsonLink, {}, {\r\n          licenseKey: window.DynaConfig.licenseKey\r\n        }).then((renderResult) => {\r\n            console.log('renderResult', renderResult)\r\n            window.currentDpParameters.original.value = renderResult;\r\n          //   const eventForSession = new CustomEvent(\"eventForSessionManagement\", { detail: renderResult });\r\n          //   document.dispatchEvent(eventForSession);\r\n\r\n\r\n            console.log(\"jsonLink++++++++++++++++++++++++++++\");\r\n            console.log(renderResult);\r\n            console.log(dynamicDpParamsMap);\r\n\r\n            fillDynamicDpParamsMap ({\r\n              state: renderResult,\r\n              dynamicDpParamsMap: dynamicDpParamsMap\r\n            })\r\n            uploaderDivModifications( false );\r\n          })\r\n      } else {\r\n\r\n          //if session available then updating the initial dpparams to dpParams store in seesion\r\n              if( window.DynaConfig.sessionInclude && window.DynaConfig.sessionInclude == 'yes' ){\r\n                  // console.log(\"updating the session\")\r\n                  // console.log(initialDPViewerParams)\r\n\r\n                  // Retrieve stored data from localStorage\r\n                  let storedData = localStorage.getItem(\"DoogmaStorageParams\");\r\n\r\n                  if (storedData) {\r\n                      storedData = JSON.parse(storedData); // Convert JSON string to object\r\n\r\n                      // Loop through storedData and update/insert into initialDPViewerParams\r\n                      for (const key in storedData) {\r\n                          if (storedData.hasOwnProperty(key)) {\r\n                              initialDPViewerParams[key] = storedData[key]; // Update or insert\r\n                          }\r\n                      }\r\n\r\n                      console.log(\"Updated initialDPViewerParams with Session:\", initialDPViewerParams);\r\n                  }\r\n              }\r\n          //END\r\n\r\n          window.DynaViewerData = {designId: dynaViewerId, initialDPViewerParams}\r\n          renderDynaviewerDesign(dynaViewerCanvas, dynaViewerId, initialDPViewerParams, {\r\n              licenseKey: window.DynaConfig.licenseKey\r\n          }).then((renderResult) => {\r\n              console.log(\"renderResult++++++++++++++++++++++++++++\");\r\n              console.log(renderResult);\r\n\r\n              window.currentDpParameters.original.value = renderResult;\r\n\r\n              // const eventForSession = new CustomEvent(\"eventForSessionManagement\", { detail: renderResult });\r\n              // document.dispatchEvent(eventForSession);\r\n              window.DynaViewerState = JSON.parse(JSON.stringify(initialDPViewerParams))\r\n\r\n              if( window.DynaConfig.sessionInclude && window.DynaConfig.sessionInclude == 'yes' ){\r\n                  fillDynamicDpParamsMap ({\r\n                      state: renderResult,\r\n                      dynamicDpParamsMap: dynamicDpParamsMap\r\n                  })\r\n              }\r\n              uploaderDivModifications( false );\r\n          })\r\n\r\n      }\r\n    })\r\n</script>"}
